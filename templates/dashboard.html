
<!DOCTYPE html>
<html>
<head>
    <title>PDF Translation Control Panel</title>
    <style>
        body {
            font-family: "Courier New", monospace;
            background-color: #ffffff;
            color: #000000;
            margin: 20px;
            font-size: 12px;
        }
        .header {
            border: 2px solid #000000;
            padding: 10px;
            margin-bottom: 20px;
        }
        .section {
            border: 1px solid #000000;
            padding: 15px;
            margin-bottom: 15px;
        }
        .section-title {
            font-weight: bold;
            text-decoration: underline;
            margin-bottom: 10px;
        }
        button {
            background-color: #f0f0f0;
            border: 2px outset #f0f0f0;
            padding: 5px 15px;
            font-family: "Courier New", monospace;
            font-size: 11px;
            cursor: pointer;
            margin: 2px;
        }
        button:active {
            border: 2px inset #f0f0f0;
        }
        button:disabled {
            background-color: #e0e0e0;
            color: #999999;
            cursor: not-allowed;
        }
        select, input[type="text"] {
            font-family: "Courier New", monospace;
            font-size: 11px;
            border: 2px inset #f0f0f0;
            padding: 2px;
            background-color: #ffffff;
        }
        .output {
            border: 1px solid #000000;
            background-color: #f8f8f8;
            padding: 10px;
            font-family: "Courier New", monospace;
            font-size: 10px;
            white-space: pre-wrap;
            height: 200px;
            overflow-y: scroll;
            display: none;
        }
        .status {
            font-weight: bold;
            margin: 5px 0;
        }
        .admin-status {
            padding: 5px;
            margin: 10px 0;
            border: 1px solid #000000;
            background-color: #f0f0f0;
            font-size: 10px;
        }
        .locked {
            background-color: #ffe0e0;
            color: #800000;
        }
        .unlocked {
            background-color: #e0ffe0;
            color: #008000;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }
        td, th {
            border: 1px solid #000000;
            padding: 5px;
            text-align: left;
            font-size: 11px;
        }
        th {
            background-color: #e0e0e0;
            font-weight: bold;
        }
        .disabled-section {
            opacity: 0.6;
            pointer-events: none;
        }
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: none;
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .auth-box {
            border: 2px solid #000000;
            background-color: #ffffff;
            padding: 30px;
            text-align: center;
            font-family: "Courier New", monospace;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>PDF TRANSLATION CONTROL PANEL v1.0</h2>
        <p>System Status: <span style="color: green;">ONLINE</span></p>
        <div class="admin-status" id="adminStatus">
            <span id="authStatusText">Admin Status: CHECKING...</span>
            <button id="authButton" onclick="authenticate()" style="margin-left: 10px; font-size: 9px;">AUTHENTICATE</button>
        </div>
    </div>

    <!-- Authentication Overlay -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-box">
            <div style="font-weight: bold; margin-bottom: 20px;">ADMIN AUTHENTICATION REQUIRED</div>
            <div style="margin: 15px 0;">Enter admin password to access system:</div>
            <input type="password" id="authPassword" placeholder="Admin Password" 
                   style="width: 200px; margin: 10px 0; padding: 5px;">
            <div style="margin-top: 15px;">
                <button onclick="submitAuth()">AUTHENTICATE</button>
                <button onclick="hideAuth()" style="margin-left: 10px;">CANCEL</button>
            </div>
            <div id="authError" style="color: red; margin-top: 10px; display: none;"></div>
        </div>
    </div>

    <div id="mainContent">
        <div class="section">
            <div class="section-title">PDF TRANSLATION SYSTEM</div>
            <table>
                <tr>
                    <td>Select PDF File:</td>
                    <td>
                        <select id="pdfSelect" required>
                            <option value="">-- SELECT PDF FILE --</option>
                            {% for pdf in pdf_files %}
                            <option value="{{ pdf }}">{{ pdf }}</option>
                            {% endfor %}
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Translation Target:</td>
                    <td>Simplified Chinese (Automatic)</td>
                </tr>
                <tr>
                    <td>Output Format:</td>
                    <td>Individual Page PDFs in Object Storage</td>
                </tr>
                <tr>
                    <td>Action:</td>
                    <td>
                        <button onclick="startTranslation()" id="translateBtn">START TRANSLATION</button>
                        <button onclick="viewProgress()" id="progressBtn" style="margin-left: 10px;">VIEW PROGRESS</button>
                    </td>
                </tr>
            </table>
            <div id="translateStatus" class="status"></div>
            <div id="translateOutput" class="output"></div>
        </div>

        <div class="section">
            <div class="section-title">MERGE PDF PAGES</div>
            <table>
                <tr>
                    <td>Select Folder:</td>
                    <td>
                        <select id="folderSelect" required>
                            <option value="">-- SELECT FOLDER --</option>
                            {% for folder in folders %}
                            <option value="{{ folder }}">{{ folder }}</option>
                            {% endfor %}
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Action:</td>
                    <td>
                        <button onclick="startMerge()">MERGE PAGES</button>
                        <span style="margin-left: 20px; font-size: 10px;">
                            Creates a single merged PDF in the selected folder
                        </span>
                    </td>
                </tr>
            </table>
            <div id="mergeStatus" class="status"></div>
            <div id="mergeOutput" class="output"></div>
        </div>

        <div class="section">
            <div class="section-title">SYSTEM INFORMATION</div>
            <table>
                <tr><th>Property</th><th>Value</th></tr>
                <tr><td>Available PDF Files</td><td>{{ pdf_files|length }}</td></tr>
                <tr><td>Available Folders</td><td>{{ folders|length }}</td></tr>
                <tr><td>Authentication Status</td><td id="authTableStatus">LOCKED</td></tr>
                <tr><td>Server Time</td><td id="serverTime"></td></tr>
            </table>
            <button onclick="location.reload()">REFRESH DATA</button>
        </div>
    </div>

    <script>
        let isAuthenticated = false;
        let authToken = null;

        // Check authentication status on page load
        window.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            updateTime();
            setInterval(updateTime, 1000);
        });

        function updateTime() {
            document.getElementById('serverTime').textContent = new Date().toLocaleString();
        }

        function checkAuthStatus() {
            // Check if we have a valid session
            fetch('/check_auth')
                .then(response => response.json())
                .then(data => {
                    if (data.authenticated) {
                        setAuthenticatedState(true);
                    } else {
                        setAuthenticatedState(false);
                        showAuth();
                    }
                })
                .catch(() => {
                    setAuthenticatedState(false);
                    showAuth();
                });
        }

        function setAuthenticatedState(authenticated) {
            isAuthenticated = authenticated;
            const statusText = document.getElementById('authStatusText');
            const authButton = document.getElementById('authButton');
            const adminStatus = document.getElementById('adminStatus');
            const mainContent = document.getElementById('mainContent');
            const authTableStatus = document.getElementById('authTableStatus');

            if (authenticated) {
                statusText.textContent = 'Admin Status: AUTHENTICATED';
                authButton.style.display = 'none';
                adminStatus.className = 'admin-status unlocked';
                mainContent.classList.remove('disabled-section');
                authTableStatus.textContent = 'AUTHENTICATED';
                authTableStatus.style.color = 'green';
            } else {
                statusText.textContent = 'Admin Status: LOCKED';
                authButton.style.display = 'inline';
                authButton.textContent = 'AUTHENTICATE';
                adminStatus.className = 'admin-status locked';
                mainContent.classList.add('disabled-section');
                authTableStatus.textContent = 'LOCKED';
                authTableStatus.style.color = 'red';
            }
        }

        function authenticate() {
            showAuth();
        }

        function showAuth() {
            document.getElementById('authOverlay').style.display = 'flex';
            document.getElementById('authPassword').focus();
        }

        function hideAuth() {
            if (!isAuthenticated) {
                // Don't allow hiding if not authenticated
                return;
            }
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('authPassword').value = '';
            document.getElementById('authError').style.display = 'none';
        }

        function submitAuth() {
            const password = document.getElementById('authPassword').value;
            const errorDiv = document.getElementById('authError');

            fetch('/admin_auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    authToken = data.token || 'authenticated';
                    setAuthenticatedState(true);
                    document.getElementById('authOverlay').style.display = 'none';
                    document.getElementById('authPassword').value = '';
                    document.getElementById('authError').style.display = 'none';
                } else {
                    errorDiv.textContent = 'ERROR: ' + data.error;
                    errorDiv.style.display = 'block';
                    document.getElementById('authPassword').value = '';
                }
            })
            .catch(error => {
                errorDiv.textContent = 'SYSTEM ERROR: ' + error.message;
                errorDiv.style.display = 'block';
            });
        }

        function startTranslation() {
            if (!isAuthenticated) {
                showAuth();
                return;
            }

            const pdfFile = document.getElementById('pdfSelect').value;
            if (!pdfFile) {
                alert('Please select a PDF file');
                return;
            }

            const status = document.getElementById('translateStatus');
            const output = document.getElementById('translateOutput');

            status.textContent = 'PROCESSING... Please wait...';
            status.style.color = 'orange';
            output.style.display = 'block';
            output.textContent = 'Starting translation process...\n';

            fetch('/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    pdf_file: pdfFile,
                    auth_token: authToken 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    status.textContent = 'TRANSLATION COMPLETED SUCCESSFULLY';
                    status.style.color = 'green';
                    output.textContent = data.output;
                } else {
                    status.textContent = 'TRANSLATION FAILED';
                    status.style.color = 'red';
                    output.textContent = 'ERROR: ' + data.error;
                }
            })
            .catch(error => {
                status.textContent = 'SYSTEM ERROR';
                status.style.color = 'red';
                output.textContent = 'ERROR: ' + error.message;
            });
        }

        function viewProgress() {
            const output = document.getElementById('translateOutput');
            if (output.style.display === 'none') {
                output.style.display = 'block';
            } else {
                output.style.display = 'none';
            }
        }

        function startMerge() {
            if (!isAuthenticated) {
                showAuth();
                return;
            }

            const folderName = document.getElementById('folderSelect').value;
            if (!folderName) {
                alert('Please select a folder');
                return;
            }

            const status = document.getElementById('mergeStatus');
            const output = document.getElementById('mergeOutput');

            status.textContent = 'PROCESSING... Please wait...';
            status.style.color = 'orange';
            output.style.display = 'block';
            output.textContent = 'Starting merge process...\n';

            fetch('/merge', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    folder_name: folderName,
                    auth_token: authToken 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    status.textContent = 'MERGE COMPLETED SUCCESSFULLY';
                    status.style.color = 'green';
                    output.textContent = data.output;
                } else {
                    status.textContent = 'MERGE FAILED';
                    status.style.color = 'red';
                    output.textContent = 'ERROR: ' + data.error;
                }
            })
            .catch(error => {
                status.textContent = 'SYSTEM ERROR';
                status.style.color = 'red';
                output.textContent = 'ERROR: ' + error.message;
            });
        }

        // Handle Enter key in auth password field
        document.getElementById('authPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitAuth();
            }
        });
    </script>
</body>
</html>
